<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ออกบิล - หอพักนักศึกษา WS</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBCW...",
            authDomain: "domitory-1a0c3-9c643.firebaseapp.com",
            projectId: "domitory-1a0c3-9c643",
            storageBucket: "domitory-1a0c3-9c643.appspot.com",
            messagingSenderId: "1007665182785",
            appId: "1:1007665182785:web:a72f91da9f23ac6f206ec0",
            measurementId: "G-W36W2WEFCB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const billsCollection = collection(db, "bill");

        function fetchBills() {
            const tableBody = document.getElementById("billTableBody");
        
            onSnapshot(billsCollection, (querySnapshot) => {
                tableBody.innerHTML = "";
                let paidCount = 0;
                let unpaidCount = 0;
        
                const sortedBills = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => parseInt(a.room) - parseInt(b.room));
        
                sortedBills.forEach((data) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${data.room}</td>
                        <td>${data.status}</td>
                        <td>
                            <button onclick="viewDetails('${data.room}')">ดูรายละเอียด</button>
                            <button onclick="deleteBill('${data.id}', this.parentNode.parentNode)">ลบ</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
        
                    if (data.status === "ชำระแล้ว") {
                        paidCount++;
                    } else {
                        unpaidCount++;
                    }
                });
        
                updateChart(paidCount, unpaidCount);
            });
        }

        window.addBill = async function () {
            const room = prompt("กรุณากรอกหมายเลขห้อง:");
            const status = confirm("ชำระเงินแล้วหรือไม่?") ? "ชำระแล้ว" : "ยังไม่ชำระ";

            if (room) {
                await addDoc(billsCollection, { room, status });
            }
        }

        window.deleteBill = async function (id, rowElement) {
            if (confirm("ต้องการลบรายการนี้ใช่หรือไม่?")) {
                try {
                    await deleteDoc(doc(db, "bill", id));
                    console.log("ลบเอกสารสำเร็จ:", id);
                    rowElement.remove();
                    alert("ลบสำเร็จ!");
                } catch (error) {
                    console.error("เกิดข้อผิดพลาดในการลบ:", error);
                    alert("เกิดข้อผิดพลาดในการลบ กรุณาลองใหม่!");
                }
            }
        };

        window.viewDetails = function (room) {
            window.location.href = `billform.html?room=${room}`;
        };

        function updateChart(paid, unpaid) {
            if (window.paymentStatusChart) {
                window.paymentStatusChart.destroy();
            }

            const ctx1 = document.getElementById('paymentStatusChart').getContext('2d');
            window.paymentStatusChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['ชำระแล้ว', 'ยังไม่ชำระ'],
                    datasets: [{
                        data: [paid, unpaid],
                        backgroundColor: ['#4CAF50', '#FF6347']
                    }]
                }
            });
        }

        window.onload = function () {
            fetchBills();
        };

        window.toggleMenu = function() {
            const menu = document.getElementById("menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        };
    </script>
    <style>
        .menu { display: none; position: absolute; top: 50px; right: 20px; background-color: #fff; border: 1px solid #ddd; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); padding: 10px; }
        .menu ul { list-style: none; padding: 0; }
        .menu ul li { margin-bottom: 8px; }
        .menu ul li a { text-decoration: none; color: #333; }
        .menu ul li a:hover { color: #007BFF; }
        button { padding: 5px 10px; margin: 5px; cursor: pointer; border: none; background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <header>
        <h1>หอพักนักศึกษา "WS"</h1>
        <nav>
            <ul>
                <li><a href="index.html">หน้าหลัก</a></li>
                <li><a href="login.html">เข้าสู่ระบบ</a></li>
            </ul>
        </nav>
    </header>

    <section class="bill-section">
        <h2>ออกบิลห้องพัก</h2>
        <button onclick="toggleMenu()">เมนู</button>
        <button onclick="addBill()">เพิ่มบิล</button>

        <table border="1" width="100%">
            <thead>
                <tr>
                    <th>ห้อง</th>
                    <th>สถานะการชำระเงิน</th>
                    <th>ดำเนินการ</th>
                </tr>
            </thead>
            <tbody id="billTableBody"></tbody>
        </table>

        <h3>แผนภูมิวงกลมสถานะการชำระเงิน</h3>
        <canvas id="paymentStatusChart" width="400" height="400"></canvas>

        <h3>กราฟรายได้ต่อเดือน</h3>
        <canvas id="monthlyRevenueChart" width="400" height="400"></canvas>
    </section>

    <div id="menu" class="menu">
        <ul>
            <li><a href="bill.html">ออกบิล</a></li>
            <li><a href="pending-payments.html">รายการรอชำระเงิน</a></li>
            <li><a href="paid-payments.html">รายการชำระเงินแล้ว</a></li>
            <li><a href="move-out-pending.html">รอย้ายออก</a></li>
            <li><a href="moved-out.html">ย้ายออกแล้ว</a></li>
            <li><a href="manage-residents.html">จัดการข้อมูลผู้เข้าพัก</a></li>
            <li><a href="manage-room-owners.html">จัดการข้อมูลเจ้าของห้องพัก</a></li>
            <li><a href="manage-room-types.html">จัดข้อมูลประเภทห้องพัก</a></li>
            <li><a href="manage-rooms.html">จัดการห้องพัก</a></li>
            <li><a href="manage-rates.html">จัดการเรทค่าน้ำค่าไฟ</a></li>
            <li><a href="logout.html">ออกจากระบบ</a></li>
        </ul>
    </div>
</body>
</html>
