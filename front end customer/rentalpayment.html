<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCWzkum4x8wj_lStJXYbLioJIgGCN8kxE",
            authDomain: "domitory-1a0c3-9c643.firebaseapp.com",
            projectId: "domitory-1a0c3-9c643",
            storageBucket: "domitory-1a0c3-9c643.firebasestorage.app",
            messagingSenderId: "1007665182785",
            appId: "1:1007665182785:web:a72f91da9f23ac6f206ec0",
            measurementId: "G-W36W2WEFCB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const roomsData = {
            "301": { tenant: "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", rent: 5000, due: 1000, water: 150, electricity: 550 },
            "302": { tenant: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ ‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏î‡∏µ", rent: 4800, due: 500, water: 200, electricity: 600 },
            "303": { tenant: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", rent: 5200, due: 1200, water: 180, electricity: 650 }
        };

        function getRoomNumber() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("room");
        }

        function displayRoomInfo() {
            const roomNumber = getRoomNumber();
            if (!roomNumber || !roomsData[roomNumber]) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å");
                return;
            }

            const room = roomsData[roomNumber];

            document.getElementById("roomNumber").innerText = roomNumber;
            document.getElementById("tenantName").innerText = room.tenant;
            document.getElementById("rentAmount").innerText = room.rent.toLocaleString();
            document.getElementById("dueAmount").innerText = room.due.toLocaleString();
            document.getElementById("waterBill").innerText = room.water.toLocaleString();
            document.getElementById("electricityBill").innerText = room.electricity.toLocaleString();
            document.getElementById("totalAmount").innerText = (room.rent + room.due + room.water + room.electricity).toLocaleString();
        }

        async function savePaymentToFirestore() {
            const roomNumber = getRoomNumber();
            const phoneNumber = document.getElementById("phoneNumber").value;
        
            if (!roomNumber || !roomsData[roomNumber]) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å");
                return;
            }
            if (!phoneNumber) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
                return;
            }
        
            const room = roomsData[roomNumber];
            const totalAmount = room.rent + room.due + room.water + room.electricity;
        
            try {
                const paymentRef = doc(db, "payments", roomNumber);
                const docSnap = await getDoc(paymentRef);

                const paymentData = {
                    roomNumber: roomNumber,
                    tenantName: room.tenant,
                    phoneNumber: phoneNumber,
                    amount: totalAmount,
                    paymentStatus: "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß",
                    timestamp: new Date()
                };

                if (docSnap.exists()) {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const existingData = docSnap.data();
                    let hasChanges = false;
                    for (let key in paymentData) {
                        if (existingData[key] !== paymentData[key]) {
                            hasChanges = true;
                            break;
                        }
                    }

                    if (hasChanges) {
                        await setDoc(paymentRef, paymentData, { merge: true });
                        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‚úÖ");
                    } else {
                        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚õî");
                    }
                } else {
                    await setDoc(paymentRef, paymentData);
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‚úÖ");
                }
        
                window.location.href = `receipt.html?room=${roomNumber}&phone=${phoneNumber}`;
            } catch (error) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            }
        }

        window.onload = () => {
            displayRoomInfo();
            document.getElementById("paymentButton").addEventListener("click", savePaymentToFirestore);
        };
    </script>
</head>
<body style="background-color: #ffe6f0;">
    <div style="display: flex; justify-content: center; gap: 50px; padding-top: 50px;">
        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0px 4px 6px rgba(0,0,0,0.1);">
            <h2>üè† Profile</h2>
            <p><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> <span id="roomNumber">?</span></p>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</strong> <span id="tenantName">-</span></p>
            <p>üìÖ <strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å:</strong> 01/09/67 - 01/09/68</p>
            <button style="background: red; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1);">
            <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
            <p><strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</strong> <span id="rentAmount">-</span> ‡∏ö‡∏≤‡∏ó</p>
            <p><strong>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> <span id="dueAmount">-</span> ‡∏ö‡∏≤‡∏ó</p>
            <p><strong>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥:</strong> <span id="waterBill">-</span> ‡∏ö‡∏≤‡∏ó</p>
            <p><strong>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü:</strong> <span id="electricityBill">-</span> ‡∏ö‡∏≤‡∏ó</p>
            <p style="background: yellow; padding: 10px; border-radius: 5px;"><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</strong> <span id="totalAmount">-</span> ‡∏ö‡∏≤‡∏ó</p>
            
            <input type="text" id="phoneNumber" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <button id="paymentButton" style="background: green; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>
</body>
</html>
